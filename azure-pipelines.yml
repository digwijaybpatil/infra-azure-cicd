trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - develop

pool:
  name: "Self-hosted-pool"

variables:
  - group: terraform-secrets # contains ARM_CLIENT_ID, etc.

  # backend configuration
  - name: TF_BACKEND_RESOURCE_GROUP
    value: "rg-digwi-terraform-remote"
  - name: TF_BACKEND_STORAGE_ACCOUNT
    value: "stgdigwiterraformstate"
  - name: TF_BACKEND_CONTAINER_NAME
    value: "tfstate"

  # Default values (will be overridden dynamically)
  - name: TF_ENVIRONMENT
    value: "dev"
  - name: TF_BACKEND_KEY
    value: "dev.terraform.tfstate"

  - name: TF_WORKING_DIR
    value: "."

stages:
  # ======================================================
  # 1Ô∏è‚É£ Terraform Init and Plan
  # ======================================================
  - stage: InitAndPlan
    displayName: "Terraform Init and Plan"

    jobs:
      - job: TerraformInitAndPlan
        displayName: "Terraform Init and Plan Job"

        steps:
          - checkout: self

          # üß© Dynamically set environment and backend key
          - powershell: |
              Write-Host "## Detecting Environment..."
              if ("$(Build.SourceBranchName)" -eq "main") {
                Write-Host "##vso[task.setvariable variable=TF_ENVIRONMENT]prod"
                Write-Host "##vso[task.setvariable variable=TF_BACKEND_KEY]prod.terraform.tfstate"
              }
              else {
                Write-Host "##vso[task.setvariable variable=TF_ENVIRONMENT]dev"
                Write-Host "##vso[task.setvariable variable=TF_BACKEND_KEY]dev.terraform.tfstate"
              }
              Write-Host "Environment = $(TF_ENVIRONMENT)"
              Write-Host "Backend Key = $(TF_BACKEND_KEY)"
            displayName: "Set Environment and Backend Key"

          - powershell: |
              terraform -version
              az --version
            displayName: "Check Terraform and Azure CLI Versions"

          - powershell: |
              Write-Host "üß© Terraform Init"
              terraform init `
                -backend-config="resource_group_name=$(TF_BACKEND_RESOURCE_GROUP)" `
                -backend-config="storage_account_name=$(TF_BACKEND_STORAGE_ACCOUNT)" `
                -backend-config="container_name=$(TF_BACKEND_CONTAINER_NAME)" `
                -backend-config="key=$(TF_BACKEND_KEY)"

              Write-Host "üß© Terraform Validate"
              terraform validate

              Write-Host "üß© Terraform Plan"
              terraform plan -input=false `
                -var-file="env/$(TF_ENVIRONMENT)/$(TF_ENVIRONMENT).tfvars" `
                -out=tfplan
            displayName: "Terraform Init, Validate & Plan"
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)

          - publish: $(System.DefaultWorkingDirectory)/tfplan
            artifact: terraform-plan
            displayName: "üì¶ Upload Terraform Plan Artifact"

  # ======================================================
  # 2Ô∏è‚É£ Terraform Apply (Main Branch Only)
  # ======================================================
  - stage: Apply
    displayName: "Terraform Apply"
    dependsOn: InitAndPlan
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
    jobs:
      - deployment: TerraformApply
        displayName: "Terraform Apply Stage"
        environment: "production" # manual approval before apply
        pool:
          name: "Self-hosted-pool"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - powershell: |
                    Write-Host "##vso[task.setvariable variable=TF_ENVIRONMENT]prod"
                    Write-Host "##vso[task.setvariable variable=TF_BACKEND_KEY]prod.terraform.tfstate"
                    Write-Host "Environment = $(TF_ENVIRONMENT)"
                  displayName: "Set Environment for Apply"

                - powershell: |
                    Write-Host "üöÄ Terraform Init for Apply"
                    terraform init `
                      -backend-config="resource_group_name=$(TF_BACKEND_RESOURCE_GROUP)" `
                      -backend-config="storage_account_name=$(TF_BACKEND_STORAGE_ACCOUNT)" `
                      -backend-config="container_name=$(TF_BACKEND_CONTAINER_NAME)" `
                      -backend-config="key=$(TF_BACKEND_KEY)"

                    Write-Host "üß© Terraform Apply"
                    terraform apply -auto-approve `
                      -var-file="env/$(TF_ENVIRONMENT)/$(TF_ENVIRONMENT).tfvars"
                  displayName: "Terraform Apply"
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
